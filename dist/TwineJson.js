window.onload=function(){"undefined"==typeof window.TwineJson&&(window.TwineJson={convert:function(){for(var e=window.document.getElementById("output"),n=this["export"](),t=JSON.parse(n),r=t,s=[],i=0;i<r.length;i++)if(r[i].children=[],""!=r[i].childrenNames){for(var u=r[i].childrenNames.split(","),a=0;a<u.length;a++)for(var o=0;o<r.length;o++)u[a]=="[["+r[o].name+"]]"&&r[i].children.push(r[o]);s.push(r[i])}console.dir(s[0]),e.innerHTML=JSON.stringify(s[0])},"export":function(){var e=[];e.push("[\r\n");var n=window.document.getElementsByTagName("tw-storydata");n&&e.push(this.buildPassage("StoryTitle","",n[0].getAttribute("name")));var t=window.document.getElementById("twine-user-script");t&&e.push(this.buildPassage("UserScript","script",t.innerHTML));var r=window.document.getElementById("twine-user-stylesheet");r&&e.push(this.buildPassage("UserStylesheet","stylesheet",r.innerHTML));for(var s=window.document.getElementsByTagName("tw-passagedata"),i=0;i<s.length;++i)e.push(this.buildPassageFromElement(s[i],i,s.length));return e.push("]\r\n"),e.join("")},buildPassageFromElement:function(e,n,t){var r=!1;n+1==t&&(r=!0);var s=e.getAttribute("name");s||(s="Untitled Passage");var i=e.getAttribute("tags"),u=e.textContent;return this.buildPassage(s,i,u,r)},buildPassage:function(e,n,t,r){var s=[];s.push("{\r\n"),s.push('	"name" : '),s.push('"',e,'"'),n&&(s.push(",\r\n"),s.push('	"tags" : '),s.push('"[',n,']"'));var i=this.scrub(t," ");return s.push(",\r\n"),s.push('	"content" : '),s.push('"',i,'",\r\n'),s.push('	"childrenNames" : '),s.push('"',this.findChildren(i),'",\r\n'),s.push('	"features" :'),s.push("",this.findFeatures(t),"\r\n"),s.push(r?"}\r\n":"},\r\n"),s.join("")},scrub:function(e,n){return e&&(e=e.replace(/\"/gm,"'"),e=e.replace(/(\r\n|\n|\r)/gm,n)),e},findChildren:function(e){for(var n,t=/\[\[(.+?)\]\]/gm,r=[];null!=(n=t.exec(e));)r.push(n[0]);return r},findFeatures:function(e){for(var n,t=/\{\{features\}\}((\s|\S)+?)\{\{\/features\}\}/gm,r=[];null!=(n=t.exec(e));){for(var s=n[1].split(/(\r\n|\n|\r|\,)/gm),i=0;i<s.length;i++)s[i].length<3&&(s.splice(i,1),i=-1);for(var i=0;i<s.length;i++){var u={};"*"==s[i][0]&&(u.star=!0,s[i]=s[i].substring(1)),"+"==s[i][0]&&(u.delta=!0,s[i]=s[i].substring(1)),"-"==s[i][0]&&(u.optional=!0,s[i]=s[i].substring(1)),u.name=s[i],r.push(u)}}return JSON.stringify(r)}}),window.TwineJson.convert()};