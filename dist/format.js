window.storyFormat({
	"name":"TwineJson",
	"version":"0.0.3",
	"author":"<a href='http://www.papricacomunicacao.com.br'>Páprica Comunicação</a>",
	"description":"Free utility format to export your story into json format. Based on Entweedle by Michael McCollum",
	"image":"icon.svg",
	"url":"http://www.papricacomunicacao.com.br",
	"license":"<a href='http://opensource.org/licenses/MIT'>MIT License</a>",
	"proofing":false,
	"source":"<html><head><title>{{STORY_NAME}}</title></head><body><script type=text/javascript>window.onload=function(){if(\"undefined\"==typeof window.TwineJson){var e={isHierarchical:!0,exportFeatures:!0};window.TwineJson={isCyclic:function(e){function r(e){if(e&&\"object\"==typeof e){if(-1!==n.indexOf(e))return!0;n.push(e);for(var t in e)if(e.hasOwnProperty(t)&&r(e[t]))return console.error(e,\"Found cycle at \"+t),!0}return!1}var n=[];return r(e)},convert:function(){var r=window.document.getElementById(\"output\"),n=this[\"export\"](),t=JSON.parse(n),s=t;if(e.isHierarchical){for(var i=[],a=0;a<s.length;a++)if(s[a].children=[],\"\"!=s[a].childrenNames){for(var u=s[a].childrenNames.split(\",\"),o=0;o<u.length;o++)for(var l=0;l<s.length;l++)u[o]==\"[[\"+s[l].name+\"]]\"&&s[a].children.push(s[l]);i.push(s[a])}this.isCyclic(i[0])?r.innerHTML=\"<h2>Error: Cyclic reference found</h2><br>Cyclic references aren't allowed in hierarchical JSON structures.<br>Please set ExportOptions.isHierarchical to false to use cyclic references.\":(console.dir(i[0]),r.innerHTML=JSON.stringify(i[0]))}else r.innerHTML=JSON.stringify(s)},\"export\":function(){var e=[];e.push(\"[\\r\\n\");var r=window.document.getElementsByTagName(\"tw-storydata\");r&&e.push(this.buildPassage(\"StoryTitle\",\"\",r[0].getAttribute(\"name\")));var n=window.document.getElementById(\"twine-user-script\");n&&e.push(this.buildPassage(\"UserScript\",\"script\",n.innerHTML));var t=window.document.getElementById(\"twine-user-stylesheet\");t&&e.push(this.buildPassage(\"UserStylesheet\",\"stylesheet\",t.innerHTML));for(var s=window.document.getElementsByTagName(\"tw-passagedata\"),i=0;i<s.length;++i)e.push(this.buildPassageFromElement(s[i],i,s.length));return e.push(\"]\\r\\n\"),e.join(\"\")},buildPassageFromElement:function(e,r,n){var t=!1;r+1==n&&(t=!0);var s=e.getAttribute(\"name\");s||(s=\"Untitled Passage\");var i=e.getAttribute(\"tags\"),a=e.textContent;return this.buildPassage(s,i,a,t)},buildPassage:function(r,n,t,s){var i=[];i.push(\"{\\r\\n\"),i.push('\t\"name\" : '),i.push('\"',r,'\"'),n&&(i.push(\",\\r\\n\"),i.push('\t\"tags\" : '),i.push('\"[',n,']\"'));var a=this.scrub(t,\" \");return i.push(\",\\r\\n\"),i.push('\t\"content\" : '),i.push('\"',a,'\"'),i.push(\",\\r\\n\"),i.push('\t\"childrenNames\" : '),i.push('\"',this.findChildren(a),'\"'),e.exportFeatures&&(i.push(\",\\r\\n\"),i.push('\t\"features\" :'),i.push(\"\",this.findFeatures(t),\"\\r\\n\")),i.push(s?\"}\\r\\n\":\"},\\r\\n\"),i.join(\"\")},scrub:function(e,r){return e&&(e=e.replace(/\\\"/gm,\"'\"),e=e.replace(/(\\r\\n|\\n|\\r)/gm,r)),e},findChildren:function(e){for(var r,n=/\\[\\[(.+?)\\]\\]/gm,t=[];null!=(r=n.exec(e));)t.push(r[0]);return t},findFeatures:function(e){for(var r,n=/\\{\\{features\\}\\}((\\s|\\S)+?)\\{\\{\\/features\\}\\}/gm,t=[];null!=(r=n.exec(e));){for(var s=r[1].split(/(\\r\\n|\\n|\\r)/gm),i=0;i<s.length;i++)s[i].length<=1&&(s.splice(i,1),i=-1);for(var i=0;i<s.length;i++){var a=/\\(([^)]+)\\)/,u=a.exec(s[i]),o={};null!=u&&u[1]&&(s[i]=s[i].replace(/\\(([^)]+)\\)/gi,\"\"),o.subtitle=u[1]),\":\"==s[i][0]&&(o.separator=!0,s[i]=s[i].substring(1)),\"*\"==s[i][0]&&(o.star=!0,s[i]=s[i].substring(1)),\"+\"==s[i][0]&&(o.delta=!0,s[i]=s[i].substring(1)),\"-\"==s[i][0]&&(o.optional=!0,s[i]=s[i].substring(1)),o.name=s[i],t.push(o)}}return JSON.stringify(t)}}}window.TwineJson.convert()};</script><pre id=output></pre><div id=storyData style=\"display: none;\">{{STORY_DATA}}</div></body></html>"
});