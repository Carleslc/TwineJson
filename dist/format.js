window.storyFormat({
	"name":"TwineJson",
	"version":"0.0.9",
	"author":"<a href='http://cau.li'>Cauli Tomaz</a>",
	"description":"Free utility format to export your story into JSON format. Based on Entweedle by Michael McCollum",
	"image":"icon.svg",
	"url":"https://github.com/cauli/TwineJson",
	"license":"<a href='http://opensource.org/licenses/MIT'>MIT License</a>",
	"proofing":false,
	"source":"<html><head><title>{{STORY_NAME}}</title></head><body><script type=text/javascript>\"use strict\";var saveAs=saveAs||function(e){if(!(\"undefined\"==typeof e||\"undefined\"!=typeof navigator&&/MSIE [1-9]\\./.test(navigator.userAgent))){var t=e.document,r=function(){return e.URL||e.webkitURL||e},n=t.createElementNS(\"http://www.w3.org/1999/xhtml\",\"a\"),i=\"download\"in n,o=function(e){var t=new MouseEvent(\"click\");e.dispatchEvent(t)},s=/constructor/i.test(e.HTMLElement),a=/CriOS\\/[\\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l=\"application/octet-stream\",c=4e4,f=function(e){var t=function(){\"string\"==typeof e?r().revokeObjectURL(e):e.remove()};setTimeout(t,c)},d=function(e,t,r){t=[].concat(t);for(var n=t.length;n--;){var i=e[\"on\"+t[n]];if(\"function\"==typeof i)try{i.call(e,r||e)}catch(o){u(o)}}},p=function(e){return/^\\s*(?:text\\/\\S*|application\\/xml|\\S*\\/\\S*\\+xml)\\s*;.*charset\\s*=\\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},h=function(t,u,c){c||(t=p(t));var h,g=this,v=t.type,m=v===l,y=function(){d(g,\"writestart progress write writeend\".split(\" \"))},w=function(){if((a||m&&s)&&e.FileReader){var n=new FileReader;return n.onloadend=function(){var t=a?n.result:n.result.replace(/^data:[^;]*;/,\"data:attachment/file;\"),r=e.open(t,\"_blank\");r||(e.location.href=t),t=void 0,g.readyState=g.DONE,y()},n.readAsDataURL(t),void(g.readyState=g.INIT)}if(h||(h=r().createObjectURL(t)),m)e.location.href=h;else{var i=e.open(h,\"_blank\");i||(e.location.href=h)}g.readyState=g.DONE,y(),f(h)};return g.readyState=g.INIT,i?(h=r().createObjectURL(t),void setTimeout(function(){n.href=h,n.download=u,o(n),y(),f(h),g.readyState=g.DONE})):void w()},g=h.prototype,v=function(e,t,r){return new h(e,t||e.name||\"download\",r)};return\"undefined\"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,r){return t=t||e.name||\"download\",r||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(g.abort=function(){},g.readyState=g.INIT=0,g.WRITING=1,g.DONE=2,g.error=g.onwritestart=g.onprogress=g.onwrite=g.onabort=g.onerror=g.onwriteend=null,v)}}(\"undefined\"!=typeof self&&self||\"undefined\"!=typeof window&&window||this.content);\"undefined\"!=typeof module&&module.exports?module.exports.saveAs=saveAs:\"undefined\"!=typeof define&&null!==define&&null!==define.amd&&define([],function(){return saveAs});var TwineJson=function(e,t){var r=0,n={isHierarchical:!0,exportOrder:!0,exportFeatures:!0,exportID:!0,exportCustomProperties:!0,exportPosition:!0,customPropertiesToIgnore:[\"features\",\"order\"],saveAsFile:!0};e={saveAsFile:function(e,r){var n=new Blob([r],{type:\"text/json;charset=utf-8\"});t(n,e.replace(/[^a-z0-9]/gi,\"\").toLowerCase()+\"-\"+Math.floor(Date.now()/1e3)+\".json\")},isCyclic:function(e){function t(e){if(e&&\"object\"==typeof e){if(r.indexOf(e)!==-1)return!0;r.push(e);for(var n in e)if(e.hasOwnProperty(n)&&t(e[n]))return console.error(e,\"Found cycle at \"+n),!0}return!1}var r=[];return t(e)},convert:function(){var e=window.document.getElementsByTagName(\"tw-storydata\"),t=window.document.getElementById(\"output\"),r=this[\"export\"](),i=JSON.parse(r),o=i;if(n.isHierarchical){for(var s=[],a=0;a<o.length;a++)if(o[a].children=[],\"\"!==o[a].childrenNames){for(var u=o[a].childrenNames.split(\",\"),l=0;l<u.length;l++)for(var c=0;c<o.length;c++)u[l]==\"[[\"+o[c].name+\"]]\"&&o[a].children.push(o[c]);s.push(o[a])}this.isCyclic(s[0])?t.innerHTML=\"<h2>Error: Cyclic reference found</h2><br>Cyclic references aren't allowed in hierarchical JSON structures.<br>Please set ExportOptions.isHierarchical to false to use cyclic references.\":(console.dir(s[0]),t.innerHTML=JSON.stringify(s[0]),n.saveAsFile&&this.saveAsFile(e[0].getAttribute(\"name\"),JSON.stringify(s[0])))}else n.saveAsFile&&this.saveAsFile(e[0].getAttribute(\"name\"),JSON.stringify(o)),t.innerHTML=JSON.stringify(o)},\"export\":function(){var e=[];e.push(\"[\"+NL);var t=window.document.getElementsByTagName(\"tw-storydata\");t&&e.push(this.buildPassage(\"StoryTitle\",\"\",t[0].getAttribute(\"name\")));var r=window.document.getElementById(\"twine-user-script\");r&&e.push(this.buildPassage(\"UserScript\",\"script\",r.innerHTML));var n=window.document.getElementById(\"twine-user-stylesheet\");n&&e.push(this.buildPassage(\"UserStylesheet\",\"stylesheet\",n.innerHTML));for(var i=window.document.getElementsByTagName(\"tw-passagedata\"),o=0;o<i.length;++o)e.push(this.buildPassageFromElement(i[o],o,i.length));return e.push(\"]\"+NL),e.join(\"\")},buildPassageFromElement:function(e,t,r){var n=!1;t+1==r&&(n=!0);var i=e.getAttribute(\"name\");i||(i=\"Untitled Passage\");var o=e.getAttribute(\"tags\"),s=e.getAttribute(\"position\"),a=e.textContent;return this.buildPassage(i,o,a,s||\"\",n)},buildPassage:function(e,t,i,o,s){var a={};n.exportID?a.id=r:null,n.exportPosition?a.position=o:null,a.name=e,\"undefined\"!=typeof t&&(a.tags=t.split(\",\"));var u=this.scrub(i,\" \");return a.content=u,a.childrenNames=this.findChildren(scrubbedContent),n.exportFeatures?a.features=this.findFeatures(i):null,n.exportOrder?a.order=this.findOrder(i):null,n.exportOtherProperties?this.findOtherProperties(a,i,n.ignoreCustomProperties):null,a.push(this.findOtherProperties(i,n.ignoreCustomProperties)),s?a.push(\"}\"+NL):a.push(\"},\"+NL),a.join(\"\")},findOtherProperties:function(e,t,r){for(var n,i=\"\",o=/\\{\\{((\\s|\\S)+?)\\}\\}((\\s|\\S)+?)\\{\\{\\/\\1\\}\\}/gm;null!==(n=o.exec(t));){var s=n[1];if(r.indexOf(s)==-1){for(var a=n[3].split(/(\\r\\n|\\n|\\r)/gm),u=[],l=0;l<a.length;l++)a[l].length<=1&&(a.splice(l,1),l=-1);if(1===a.length)e[s]=a[0];else{for(var c={},f=0;f<a.length;f++)c[f]=a[f];u.push(c),i+=\",\"+NL,i+=TAB+'\"'+s+'\" :',i+=\"\"+JSON.stringify(u)+NL}}}return i},scrub:function(e,t){return e&&(e=e.replace(/\\\"/gm,\"'\"),e=e.replace(/(\\r\\n|\\n|\\r)/gm,t)),e},findChildren:function(e){for(var t,r=/\\[\\[(.+?)\\]\\]/gm,n=[];null!==(t=r.exec(e));)n.push(t[0]);return n},findOrder:function(e){for(var t,r=/\\{\\{order\\}\\}((\\s|\\S)+?)\\{\\{\\/order\\}\\}/gm,n=[];null!==(t=r.exec(e));){for(var i=t[1].split(/(\\r\\n|\\n|\\r)/gm),o=0;o<i.length;o++)i[o].length<=1&&(i.splice(o,1),o=-1);for(var s=0;s<i.length;s++)featureJSON.order=i[s],n.push(featureJSON)}return JSON.stringify(n)},findFeatures:function(e){for(var t,r=/\\{\\{features\\}\\}((\\s|\\S)+?)\\{\\{\\/features\\}\\}/gm,n=[];null!==(t=r.exec(e));){for(var i=t[1].split(/(\\r\\n|\\n|\\r)/gm),o=0;o<i.length;o++)i[o].length<=1&&(i.splice(o,1),o=-1);for(var s=0;s<i.length;s++){var a=/\\(([^)]+)\\)/,u=a.exec(i[s]),l={};null!==u&&u[1]&&(i[s]=i[s].replace(/\\(([^)]+)\\)/gi,\"\"),l.subtitle=u[1]),\":\"==i[s][0]&&(l.separator=!0,i[s]=i[s].substring(1)),\"*\"==i[s][0]&&(l.star=!0,i[s]=i[s].substring(1)),\"+\"==i[s][0]&&(l.delta=!0,i[s]=i[s].substring(1)),\"-\"==i[s][0]&&(l.optional=!0,i[s]=i[s].substring(1)),l.name=i[s],n.push(l)}}return JSON.stringify(n)}}}(TwineJson||{},saveAs);TwineJson.convert();</script><pre id=output></pre><div id=storyData style=\"display: none;\">{{STORY_DATA}}</div></body></html>"
});